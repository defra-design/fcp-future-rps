{% extends "layouts/beta-header.html" %}

{% block pageTitle %}
  Defra Map Test - Land Parcel Selection
{% endblock %}

{% block bodyStart %}
  <script>document.body.classList.add('am-is-loading')</script>
{% endblock %}

{% block beforeContent %}
  <!-- Defra Map CSS -->
  <link rel="stylesheet" href="/plugin-assets/%40defra%2Fdefra-map/dist/css/defra-map.css">
  
  <!-- MapLibre GL CSS for scale control -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.css">
  
  <style>
    .defra-map-container {
      border: 2px solid #b1b4b6;
      margin-bottom: 20px;
      height: 500px;
      width: 100%;
      position: relative;
    }
    
    #map {
      height: 100%;
      width: 100%;
    }
    
    body.am-is-loading .defra-map-container {
      opacity: 0.5;
    }
    
    /* Fixed info panel on left side of map */
    .parcel-info-panel {
      position: absolute;
      left: 0;
      top: 0;
      width: 200px;
      height: 100%;
      background: white;
      border-right: 2px solid #b1b4b6;
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
      z-index: 1000;
      font-family: "GDS Transport", arial, sans-serif;
      overflow-y: auto;
      display: none; /* Hidden by default */
    }
    
    .parcel-info-panel.visible {
      display: block;
    }
    
    .parcel-info-panel-close {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #0b0c0c;
      line-height: 1;
    }
    
    .parcel-info-panel-close:hover {
      color: #505a5f;
    }
    
    .parcel-info-panel-content {
      padding: 15px;
    }
    
    .parcel-info-panel h3 {
      margin-top: 0;
      margin-bottom: 10px;
      padding-right: 20px;
      font-size: 16px;
      font-weight: 700;
      color: #0b0c0c;
    }
    
    .parcel-info-panel p {
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.4;
      color: #0b0c0c;
    }
    
    .parcel-info-panel p strong {
      font-weight: 700;
    }
  </style>
  
  {% include "_common/sub-header-beta.html" %}

  {{ govukBackLink({
    text: "Back",
    href: "javascript:window.history.back()"
  }) }}
{% endblock %}

{% block content %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-l">Defra Map Component Test</h1>
    <p class="govuk-body">This is a test page showing the defra-map component with basic land parcel selection functionality.</p>
    
    {{ govukInsetText({
      html: '<strong>Note:</strong> This uses MapLibre GL for rendering with live RPA API data integration. Enter an SBI to load customer land parcels, land cover, and boundaries.'
    }) }}

    <!-- SBI Input Form -->
    <div class="govuk-form-group" id="sbi-input-group">
      <label class="govuk-label govuk-label--s" for="sbi-input">
        Single Business Identifier (SBI)
      </label>
      <div class="govuk-hint">
        Enter a 9-digit SBI to load land parcels. Use <strong>999999999</strong> for demo data.
      </div>
      <div style="display: flex; gap: 10px; align-items: flex-start;">
        <input class="govuk-input govuk-input--width-10" id="sbi-input" name="sbi" type="text" value="106332870">
        <button class="govuk-button" data-module="govuk-button" onclick="loadRPAData(); return false;">
          Load Land Parcels
        </button>
      </div>
      <div id="loading-message" style="display: none; margin-top: 10px;">
        <p class="govuk-body"><strong>Loading...</strong></p>
      </div>
      <div id="error-message" style="display: none; margin-top: 10px;">
        <p class="govuk-error-message"></p>
      </div>
    </div>

    <!-- Full width map -->
    <h2 class="govuk-heading-m">Interactive Map</h2>
    
    <!-- Map container -->
    <div class="defra-map-container">
      <!-- Info panel (fixed to left side) -->
      <div id="parcel-info-panel" class="parcel-info-panel">
        <button class="parcel-info-panel-close" onclick="closeInfoPanel()">&times;</button>
        <div class="parcel-info-panel-content" id="parcel-info-content">
          <!-- Content will be inserted here -->
        </div>
      </div>
      
      <div id="map" data-zoom="15" data-center="[-1.2520, 51.7495]"></div>
    </div>
    
    <details class="govuk-details">
      <summary class="govuk-details__summary">
        <span class="govuk-details__summary-text">
          Map controls guide
        </span>
      </summary>
      <div class="govuk-details__text">
        <ul class="govuk-list govuk-list--bullet">
          <li>Use zoom controls (+/-) to zoom in and out</li>
          <li>Click and drag to pan the map</li>
          <li>Use keyboard: Arrow keys to pan, +/- to zoom</li>
          <li>Scale bar shows map scale</li>
        </ul>
      </div>
    </details>

    <h2 class="govuk-heading-m">Land Parcels</h2>
    
    <div id="parcels-loading" style="display: none;">
      <p class="govuk-body">Loading parcels...</p>
    </div>
    
    <div id="parcels-list-container">
      <p class="govuk-body">Enter an SBI above to load land parcels.</p>
    </div>

    {{ govukWarningText({
      text: "Click on any colored parcel to select it. The selected parcel will highlight with a green border. This demonstrates GeoJSON layer overlays with click interactions.",
      iconFallbackText: "Note"
    }) }}

    <h3 class="govuk-heading-s govuk-!-margin-top-6">Technical Details</h3>
    <dl class="govuk-summary-list govuk-summary-list--no-border">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Component</dt>
        <dd class="govuk-summary-list__value">defra.DefraMap</dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Map Provider</dt>
        <dd class="govuk-summary-list__value">MapLibre GL JS</dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Base Map</dt>
        <dd class="govuk-summary-list__value">OpenFreeMap Liberty</dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Behaviour</dt>
        <dd class="govuk-summary-list__value">Hybrid (interactive + accessible)</dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Plugins</dt>
        <dd class="govuk-summary-list__value">Zoom controls, Scale bar</dd>
      </div>
    </dl>

  </div>
</div>

{% endblock %}

{% block pageScripts %}
  <!-- Preact dependencies - MUST be loaded in this order -->
  <script src="https://unpkg.com/preact@10.19.3/dist/preact.umd.js"></script>
  <script src="https://unpkg.com/preact@10.19.3/hooks/dist/hooks.umd.js"></script>
  <script src="https://unpkg.com/preact@10.19.3/compat/dist/compat.umd.js"></script>
  <script src="https://unpkg.com/preact@10.19.3/jsx-runtime/dist/jsxRuntime.umd.js"></script>

  <!-- Preact shim -->
  <script src="/plugin-assets/%40defra%2Fdefra-map/assets/js/preactShim.js"></script>

  <!-- MapLibre GL JS for scale control -->
  <script src="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.js"></script>

  <!-- Defra map libraries -->
  <script src="/plugin-assets/%40defra%2Fdefra-map/dist/umd/maplibre-provider.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/dist/umd/scale-bar-plugin.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/dist/umd/zoom-controls-plugin.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/dist/umd/defra-map.js"></script>

  <script>
    // Initialize MapLibre directly with OSM raster tiles
    var map = new maplibregl.Map({
      container: 'map',
      center: [-2.5, 53.0], // Center of England
      zoom: 6,
      minZoom: 5,
      maxZoom: 18,
      style: {
        version: 8,
        glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
        sources: {
          'osm-tiles': {
            type: 'raster',
            tiles: [
              'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
              'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
              'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
            ],
            tileSize: 256,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }
        },
        layers: [
          {
            id: 'osm',
            type: 'raster',
            source: 'osm-tiles',
            minzoom: 0,
            maxzoom: 22
          }
        ]
      }
    });

    var selectedParcelId = null;
    var parcelGeoJSON; // Store globally so we can access it from list clicks
    
    // Add zoom controls
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // Function to show info panel
    function showInfoPanel(content) {
      var panel = document.getElementById('parcel-info-panel');
      var contentDiv = document.getElementById('parcel-info-content');
      contentDiv.innerHTML = content;
      panel.classList.add('visible');
    }
    
    // Function to close info panel
    window.closeInfoPanel = function() {
      var panel = document.getElementById('parcel-info-panel');
      panel.classList.remove('visible');
    };

    // Function to select a parcel (used by both map clicks and list clicks)
    function selectParcel(parcelId, zoomToParcel) {

      // Clear previous selection
      if (selectedParcelId !== null) {
        map.setFeatureState(
          { source: 'parcels', id: selectedParcelId },
          { selected: false }
        );
      }

      // Set new selection
      selectedParcelId = parcelId;
      map.setFeatureState(
        { source: 'parcels', id: selectedParcelId },
        { selected: true }
      );

      // Find the parcel data
      var parcel = parcelGeoJSON.features.find(function(f) {
        return f.id === parcelId;
      });

      if (parcel) {
        console.log('Selected parcel:', parcel.properties.name);

        // Optionally zoom to the parcel
        if (zoomToParcel) {
          var coords = parcel.geometry.coordinates[0];
          
          // Calculate bounds manually (min/max lng/lat)
          var lngs = coords.map(function(c) { return c[0]; });
          var lats = coords.map(function(c) { return c[1]; });
          var bounds = [
            [Math.min.apply(null, lngs), Math.min.apply(null, lats)], // southwest
            [Math.max.apply(null, lngs), Math.max.apply(null, lats)]  // northeast
          ];
          
          map.fitBounds(bounds, { padding: 100, maxZoom: 15 });
        }
      }
    }

    // Function called from list links
    window.selectParcelFromList = function(parcelId) {
      selectParcel(parcelId, true); // true = zoom to parcel
    };

    // Add scale control
    var scale = new maplibregl.ScaleControl({
      maxWidth: 100,
      unit: 'metric'
    });
    map.addControl(scale, 'bottom-left');

    // Wait for map to load before enabling interactions
    map.on('load', function() {
      console.log('Map loaded and ready');
      document.body.classList.remove('am-is-loading');
    });

    // Generate a fictional parcel name based on index
    function generateParcelName(index) {
      const fieldNames = [
        'Lower Meadow', 'Upper Field', 'Oak Tree Field', 'Long Pasture', 'Brook Field',
        'Hill Field', 'Barn Field', 'Woodland Edge', 'River Meadow', 'North Field',
        'South Field', 'East Pasture', 'West Meadow', 'Church Field', 'Mill Field',
        'Willow Field', 'Cherry Orchard', 'Sheep Pasture', 'Top Field', 'Bottom Field',
        'Middle Meadow', 'Green Field', 'White Field', 'Home Field', 'Far Field',
        'Spring Field', 'Hedge Field', 'Stone Field', 'Bridge Meadow', 'Lane Field',
        'Gate Field', 'Well Pasture', 'Ash Field'
      ];
      return fieldNames[index % fieldNames.length];
    }

    // Function to load RPA data for a given SBI
    async function loadRPAData() {
      const sbiInput = document.getElementById('sbi-input');
      const sbi = sbiInput.value.trim();
      
      if (!sbi) {
        showError('Please enter an SBI');
        return;
      }
      
      showLoading(true);
      hideError();
      
      try {
        // Use local proxy endpoint to fetch data (bypasses CORS)
        const url = `/api/rpa-proxy?sbi=${sbi}`;
        
        console.log('Fetching from local proxy:', url);
        const response = await fetch(url);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Server returned ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data || !data.features || data.features.length === 0) {
          showError('No land parcels found for this SBI');
          showLoading(false);
          return;
        }
        
        // Store globally
        parcelGeoJSON = data;
        
        // Display parcels on map
        displayParcels(data);
        
        // Update parcels list
        updateParcelsList(data);
        
        showLoading(false);
        console.log(`Loaded ${data.features.length} parcels for SBI ${sbi}`);
        
      } catch (error) {
        console.error('Error loading RPA data:', error);
        showError(`Failed to load data: ${error.message}`);
        showLoading(false);
      }
    }
    
    // Function to display parcels on the map
    function displayParcels(geojson) {
      // Remove existing parcel layers if any
      if (map.getLayer('parcels-fill')) map.removeLayer('parcels-fill');
      if (map.getLayer('parcels-outline')) map.removeLayer('parcels-outline');
      if (map.getLayer('parcels-labels')) map.removeLayer('parcels-labels');
      if (map.getSource('parcels')) map.removeSource('parcels');
      
      // Add generated parcel names to features for labeling
      geojson.features.forEach(function(feature, index) {
        var parcelName = feature.properties.PARCEL_NAME || feature.properties.DESCRIPTION;
        if (!parcelName) {
          parcelName = generateParcelName(index);
        }
        var sheetId = feature.properties.SHEET_ID || '';
        feature.properties.DISPLAY_LABEL = parcelName + '\n' + sheetId;
      });

      // Add the GeoJSON source
      map.addSource('parcels', {
        type: 'geojson',
        data: geojson
      });

      // Add fill layer for parcels
      map.addLayer({
        id: 'parcels-fill',
        type: 'fill',
        source: 'parcels',
        paint: {
          'fill-color': '#87CEEB',
          'fill-opacity': [
            'case',
            ['boolean', ['feature-state', 'selected'], false],
            0.8,
            0.4
          ]
        }
      });

      // Add outline layer for parcels
      map.addLayer({
        id: 'parcels-outline',
        type: 'line',
        source: 'parcels',
        paint: {
          'line-color': [
            'case',
            ['boolean', ['feature-state', 'selected'], false],
            '#00703c',
            '#0b0c0c'
          ],
          'line-width': [
            'case',
            ['boolean', ['feature-state', 'selected'], false],
            3,
            1.5
          ]
        }
      });

      // Add labels for parcels (showing name and ID)
      map.addLayer({
        id: 'parcels-labels',
        type: 'symbol',
        source: 'parcels',
        layout: {
          'text-field': ['get', 'DISPLAY_LABEL'],
          'text-size': 11,
          'text-anchor': 'center',
          'text-justify': 'center'
        },
        paint: {
          'text-color': '#0b0c0c',
          'text-halo-color': '#ffffff',
          'text-halo-width': 2
        }
      });

      // Change cursor on hover
      map.on('mouseenter', 'parcels-fill', function() {
        map.getCanvas().style.cursor = 'pointer';
      });

      map.on('mouseleave', 'parcels-fill', function() {
        map.getCanvas().style.cursor = '';
      });

      // Handle click events
      map.on('click', 'parcels-fill', function(e) {
        if (e.features.length > 0) {
          var feature = e.features[0];
          var parcelId = feature.id || feature.properties.SHEET_ID;
          
          // Use the shared selection function
          selectParcel(parcelId, false);
          
          // Show info panel with parcel details
          var props = feature.properties;
          var parcelName = props.PARCEL_NAME || props.DESCRIPTION;
          if (!parcelName) {
            // Generate fictional name based on feature index
            var featureIndex = parcelGeoJSON.features.findIndex(function(f) {
              return (f.id || f.properties.SHEET_ID) === parcelId;
            });
            parcelName = generateParcelName(featureIndex);
          }
          var area = props.AREA_HA ? parseFloat(props.AREA_HA).toFixed(4) + ' ha' : 'N/A';
          var panelContent = 
            '<h3>' + parcelName + '</h3>' +
            '<p><strong>Parcel ID:</strong> ' + (props.SHEET_ID || 'N/A') + '</p>' +
            '<p><strong>Area:</strong> ' + area + '</p>' +
            (props.LAND_USE ? '<p><strong>Land use:</strong> ' + props.LAND_USE + '</p>' : '') +
            (props.LFA_CODE ? '<p><strong>LFA:</strong> ' + props.LFA_CODE + '</p>' : '');
          
          showInfoPanel(panelContent);
        }
      });

      // Fit map to show all parcels
      const bounds = new maplibregl.LngLatBounds();
      geojson.features.forEach(function(feature) {
        if (feature.geometry.type === 'Polygon') {
          feature.geometry.coordinates[0].forEach(function(coord) {
            bounds.extend(coord);
          });
        } else if (feature.geometry.type === 'MultiPolygon') {
          feature.geometry.coordinates.forEach(function(polygon) {
            polygon[0].forEach(function(coord) {
              bounds.extend(coord);
            });
          });
        }
      });
      
      setTimeout(function() {
        map.fitBounds(bounds, { 
          padding: 50,
          maxZoom: 15
        });
      }, 100);
    }
    
    // Function to update the parcels list
    function updateParcelsList(geojson) {
      const container = document.getElementById('parcels-list-container');
      
      let html = '<p class="govuk-body">Your land parcels (' + geojson.features.length + ' total):</p>';
      html += '<ul class="govuk-list govuk-list--spaced">';
      
      geojson.features.forEach(function(feature, index) {
        const props = feature.properties;
        const id = feature.id || props.SHEET_ID || props.ID;
        var parcelName = props.PARCEL_NAME || props.DESCRIPTION;
        if (!parcelName) {
          parcelName = generateParcelName(index);
        }
        const sheetId = props.SHEET_ID || 'N/A';
        const displayName = parcelName + ' (' + sheetId + ')';
        const area = props.AREA_HA ? parseFloat(props.AREA_HA).toFixed(4) + ' ha' : 'N/A';
        
        html += '<li style="display: flex; justify-content: space-between;">';
        html += '<a href="#" class="govuk-link" onclick="selectParcelFromList(\'' + id + '\'); return false;">' + displayName + '</a>';
        html += '<span>' + area + '</span>';
        html += '</li>';
      });
      
      html += '</ul>';
      container.innerHTML = html;
    }
    
    // Helper functions
    function showLoading(show) {
      document.getElementById('loading-message').style.display = show ? 'block' : 'none';
    }
    
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.querySelector('p').textContent = message;
      errorDiv.style.display = 'block';
    }
    
    function hideError() {
      document.getElementById('error-message').style.display = 'none';
    }
  </script>
{% endblock %}
